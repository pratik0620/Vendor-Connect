// Language translations for supplier dashboard
const translations = {
    en: {
        welcome: "Welcome",
        supplier_dashboard: "Supplier Dashboard",
        refresh: "Refresh",
        logout: "Logout",
        product_catalog: "Product Catalog",
        add_product: "Add Product",
        product: "Product",
        price: "Price (₹/kg)",
        freshness: "Freshness",
        hygiene_rating: "Hygiene Rating",
        actions: "Actions",
        reviews: "Reviews & Ratings",
        total_reviews: "total reviews",
        vendor_orders: "Vendor Orders",
        pending: "Pending",
        fulfilled: "Fulfilled",
        group_orders: "Group Orders",
        vendor_name: "Vendor Name",
        items: "Items",
        amount: "Amount",
        order_date: "Order Date",
        delivery_date: "Delivery Date",
        status: "Status",
        profile: "Profile & Business Details",
        business_name: "Business Name",
        contact_number: "Contact Number",
        delivery_areas: "Delivery Areas",
        business_hours: "Business Hours",
        hygiene_practices: "Hygiene Practices",
        update_profile: "Update Profile",
        notifications: "Notifications",
        add_new_product: "Add New Product",
        product_name: "Product Name",
        price_per_kg: "Price per kg (₹)",
        fresh: "Fresh (< 24 hours)",
        good: "Good (1-3 days)",
        regular: "Regular (3-7 days)",
        available_quantity: "Available Quantity (kg)",
        cancel: "Cancel",
        save_product: "Save Product",
        verify: "Verify",
        fulfill: "Fulfill",
        complete: "Complete",
        review_from: "Review from",
        days_ago: "days ago",
        ordered_on: "Ordered on",
        delivered_on: "Delivered on",
        delivery_pending: "Delivery Pending",
        new_order: "New Order",
        repeat_order: "Repeat Order",
        vendor_comment: "Vendor Comment",
        group_order: "Group Order",
        vendors: "Vendors",
        total_amount: "Total Amount",
        deadline: "Deadline"
    },
    hi: {
        welcome: "स्वागत है",
        supplier_dashboard: "आपूर्तिकर्ता डैशबोर्ड",
        refresh: "रीफ्रेश करें",
        logout: "लॉगआउट करें",
        product_catalog: "उत्पाद सूची",
        add_product: "उत्पाद जोड़ें",
        product: "उत्पाद",
        price: "मूल्य (₹/किलो)",
        freshness: "ताजगी",
        hygiene_rating: "स्वच्छता रेटिंग",
        actions: "क्रियाएँ",
        reviews: "समीक्षाएँ और रेटिंग",
        total_reviews: "कुल समीक्षाएँ",
        vendor_orders: "विक्रेता के ऑर्डर",
        pending: "लंबित",
        fulfilled: "पूरे किए गए",
        group_orders: "समूह ऑर्डर",
        vendor_name: "विक्रेता का नाम",
        items: "वस्तुएँ",
        amount: "राशि",
        order_date: "ऑर्डर तिथि",
        delivery_date: "डिलीवरी तिथि",
        status: "स्थिति",
        profile: "प्रोफाइल और व्यापार विवरण",
        business_name: "व्यापार का नाम",
        contact_number: "संपर्क नंबर",
        delivery_areas: "डिलीवरी क्षेत्र",
        business_hours: "व्यापार के घंटे",
        hygiene_practices: "स्वच्छता अभ्यास",
        update_profile: "प्रोफाइल अपडेट करें",
        notifications: "सूचनाएँ",
        add_new_product: "नया उत्पाद जोड़ें",
        product_name: "उत्पाद का नाम",
        price_per_kg: "प्रति किलो मूल्य (₹)",
        fresh: "ताजा (< 24 घंटे)",
        good: "अच्छा (1-3 दिन)",
        regular: "साधारण (3-7 दिन)",
        available_quantity: "उपलब्ध मात्रा (किलो)",
        cancel: "रद्द करें",
        save_product: "उत्पाद सहेजें",
        verify: "सत्यापित करें",
        fulfill: "पूरा करें",
        complete: "पूर्ण",
        review_from: "से समीक्षा",
        days_ago: "दिन पहले",
        ordered_on: "पर ऑर्डर किया",
        delivered_on: "पर वितरित",
        delivery_pending: "डिलीवरी लंबित",
        new_order: "नया ऑर्डर",
        repeat_order: "दोहराया गया ऑर्डर",
        vendor_comment: "विक्रेता टिप्पणी",
        group_order: "समूह ऑर्डर",
        vendors: "विक्रेता",
        total_amount: "कुल राशि",
        deadline: "समाप्ति तिथि"
    },
    mr: {
        welcome: "स्वागत आहे",
        supplier_dashboard: "पुरवठादार डॅशबोर्ड",
        refresh: "रीफ्रेश करा",
        logout: "लॉगआउट करा",
        product_catalog: "उत्पादन सूची",
        add_product: "उत्पाद जोडा",
        product: "उत्पाद",
        price: "किंमत (₹/किलो)",
        freshness: "ताजेपणा",
        hygiene_rating: "स्वच्छता रेटिंग",
        actions: "कृती",
        reviews: "समीक्षा आणि रेटिंग",
        total_reviews: "एकूण समीक्षा",
        vendor_orders: "विक्रेता ऑर्डर",
        pending: "प्रलंबित",
        fulfilled: "पूर्ण केलेले",
        group_orders: "समूह ऑर्डर",
        vendor_name: "विक्रेता नाव",
        items: "वस्तू",
        amount: "रक्कम",
        order_date: "ऑर्डर तारीख",
        delivery_date: "वितरण तारीख",
        status: "स्थिती",
        profile: "प्रोफाइल आणि व्यवसाय तपशील",
        business_name: "व्यवसाय नाव",
        contact_number: "संपर्क क्रमांक",
        delivery_areas: "वितरण क्षेत्रे",
        business_hours: "व्यवसायाचे तास",
        hygiene_practices: "स्वच्छता पद्धती",
        update_profile: "प्रोफाइल अपडेट करा",
        notifications: "सूचना",
        add_new_product: "नवीन उत्पाद जोडा",
        product_name: "उत्पादाचे नाव",
        price_per_kg: "प्रति किलो किंमत (₹)",
        fresh: "ताजे (< २४ तास)",
        good: "चांगले (१-३ दिवस)",
        regular: "नियमित (३-७ दिवस)",
        available_quantity: "उपलब्ध प्रमाण (किलो)",
        cancel: "रद्द करा",
        save_product: "उत्पाद जतन करा",
        verify: "सत्यापित करा",
        fulfill: "पूर्ण करा",
        complete: "पूर्ण",
        review_from: "कडून समीक्षा",
        days_ago: "दिवसांपूर्वी",
        ordered_on: "वर ऑर्डर केले",
        delivered_on: "वर वितरित",
        delivery_pending: "वितरण प्रलंबित",
        new_order: "नवीन ऑर्डर",
        repeat_order: "पुन्हा ऑर्डर",
        vendor_comment: "विक्रेता टिप्पणी",
        group_order: "समूह ऑर्डर",
        vendors: "विक्रेते",
        total_amount: "एकूण रक्कम",
        deadline: "मुदत"
    }
};

// Mock data for supplier dashboard
const mockData = {
    supplierProducts: [
        { name: "Potato", price: 35, freshness: "Fresh", hygieneRating: 5, quantity: 200 },
        { name: "Tomato", price: 60, freshness: "Fresh", hygieneRating: 5, quantity: 150 },
        { name: "Onion", price: 40, freshness: "Good", hygieneRating: 4, quantity: 300 },
        { name: "Capsicum", price: 75, freshness: "Fresh", hygieneRating: 5, quantity: 100 },
        { name: "Ginger", price: 120, freshness: "Good", hygieneRating: 4, quantity: 80 }
    ],
    pendingOrders: [
        { vendor: "Rajesh", items: "Potato, Onion, Tomato", quantity: "10kg, 5kg, 8kg", date: "Today, 10:30 AM" },
        { vendor: "Anita", items: "Capsicum, Ginger", quantity: "3kg, 1kg", date: "Today, 11:45 AM" }
    ],
    fulfilledOrders: [
        { vendor: "Prakash", items: "Potato, Onion", amount: "₹850", deliveryDate: "Yesterday", status: "Delivered" },
        { vendor: "Rajesh", items: "Tomato, Capsicum", amount: "₹1,350", deliveryDate: "Oct 15, 2023", status: "Delivered" }
    ],
    groupOrders: [
        {
            id: 1,
            title: "Bulk Vegetable Order",
            items: ["Potato (150kg)", "Onion (100kg)", "Tomato (80kg)"],
            vendors: ["Rajesh", "Anita", "Prakash", "+3 more"],
            totalAmount: "₹15,200",
            status: "Processing",
            deadline: "Today, 4 PM"
        }
    ],
    reviews: [
        { name: "Rajesh", rating: 5, text: "Excellent quality vegetables, always fresh.", date: "3 days ago" },
        { name: "Anita", rating: 4, text: "Good service and timely delivery.", date: "1 week ago" },
        { name: "Prakash", rating: 5, text: "Best supplier in the area. Never disappoints.", date: "2 weeks ago" },
        { name: "Sanjay", rating: 4, text: "Quality products at reasonable prices.", date: "2 weeks ago" },
        { name: "Meera", rating: 5, text: "Very reliable and consistent quality.", date: "3 weeks ago" }
    ],
    supplierNotifications: [
        { type: "new_order", title: "New Order", message: "Rajesh placed a new order worth ₹950.", time: "30 min ago" },
        { type: "group_order", title: "Group Order", message: "New group purchase request for vegetables from 5 vendors.", time: "2 hours ago" },
        { type: "vendor_comment", title: "Vendor Comment", message: "Anita: 'The tomatoes were exceptionally good this time!'", time: "1 day ago" }
    ]
};

// Current language
let currentLang = "en";

// Initialize the supplier dashboard
$(document).ready(function () {
    // Check authentication first
    checkAuthentication();

    // Setup language switcher
    setupLanguageSwitcher();

    // Setup event listeners
    setupEventListeners();

    // Initialize Bootstrap components
    initBootstrapComponents();
});

// Get user ID from URL
function getUserIdFromUrl() {
    const pathParts = window.location.pathname.split('/');
    // URL format: /supplier/userId/dashboard
    if (pathParts.length >= 3 && pathParts[1] === 'supplier') {
        return pathParts[2];
    }
    return null;
}

// Check authentication and load user data
function checkAuthentication() {
    const userData = JSON.parse(localStorage.getItem("vendorconnect_user"));
    const urlUserId = getUserIdFromUrl();
    
    if (!userData || userData.role !== "supplier") {
        // No user data or wrong role, redirect to login page
        window.location.href = "/login";
        return;
    }

    // Load supplier data based on URL user ID
    loadSupplierData(urlUserId);
}

// Load supplier data from API
async function loadSupplierData(supplierId) {
    try {
        const response = await fetch(`/api/supplier/${supplierId}/info`);
        if (response.ok) {
            const supplierData = await response.json();
            // Priority: name from Supplier table, then business_name from SupplierInfo, then default
            const displayName = supplierData.name || supplierData.business_name || 'Supplier';
            showSupplierDashboard(displayName, supplierId);
        } else {
            // If supplier not found, show with generic name
            showSupplierDashboard('Supplier', supplierId);
        }
    } catch (error) {
        console.error('Error loading supplier data:', error);
        showSupplierDashboard('Supplier', supplierId);
    }
}

// Language switcher function
function setupLanguageSwitcher() {
    $(".lang-btn").click(function () {
        currentLang = $(this).data("lang");
        $(".lang-btn").removeClass("active");
        $(this).addClass("active");
        updateLanguage();

        // Save language preference
        localStorage.setItem("vendorconnect_lang", currentLang);
    });

    // Load saved language preference
    const savedLang = localStorage.getItem("vendorconnect_lang");
    if (savedLang && translations[savedLang]) {
        currentLang = savedLang;
        $(`.lang-btn[data-lang="${currentLang}"]`).click();
    }
}

// Update all text content based on selected language
function updateLanguage() {
    $("[data-i18n]").each(function () {
        const key = $(this).data("i18n");
        if (translations[currentLang] && translations[currentLang][key]) {
            $(this).text(translations[currentLang][key]);
        }
    });
}

// Setup event listeners
function setupEventListeners() {
    // Logout button
    $("#supplier-logout-btn").click(function () {
        localStorage.removeItem("vendorconnect_user");
        window.location.href = "login.html";
    });

    // Refresh data button
    $("#supplier-refresh-data").click(function () {
        location.reload();
    });

    // Save product button
    $("#save-product").click(function () {
        const productName = $("#product-name").val();
        const productPrice = $("#product-price").val();
        const productFreshness = $("#product-freshness").val();
        const hygieneRating = $("#hygiene-rating").val();
        const availableQuantity = $("#available-quantity").val();

        // Validate inputs
        if (!productName || !productPrice || !productFreshness || !hygieneRating || !availableQuantity) {
            alert("Please fill all fields");
            return;
        }

        // Add product to the list (in a real app, this would be sent to a server)
        mockData.supplierProducts.push({
            name: productName,
            price: parseInt(productPrice),
            freshness: productFreshness,
            hygieneRating: parseInt(hygieneRating),
            quantity: parseInt(availableQuantity)
        });

        // Update the product table
        updateSupplierProductsTable();

        // Close the modal
        $("#addProductModal").modal("hide");

        // Reset the form
        $("#add-product-form")[0].reset();
    });

    // Supplier profile form
    $("#supplier-profile-form").submit(function (e) {
        e.preventDefault();
        alert("Profile updated successfully!");
    });
}

// Initialize Bootstrap components
function initBootstrapComponents() {
    // Initialize any Bootstrap components if needed
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
}

// Show Supplier Dashboard
function showSupplierDashboard(displayName, supplierId) {
    $("#supplier-dashboard").show();
    $("#supplier-name").text(displayName);
    
    // Store current supplier ID for API calls
    window.currentSupplierId = supplierId;
    
    // Update header link to point to current dashboard
    $(".app-logo").attr("href", `/${supplierId}/supplier/dashboard`);

    // Load supplier dashboard data
    loadSupplierProducts(supplierId);
    loadSupplierOrders(supplierId);
    loadSupplierNotifications();
    loadSupplierReviews();
}

// Update supplier products table
function updateSupplierProductsTable() {
    const productsTable = $("#supplier-products-table tbody");
    productsTable.empty();

    mockData.supplierProducts.forEach(product => {
        const freshnessClass = product.freshness === "Fresh" ? "success" :
            (product.freshness === "Good" ? "info" : "warning");

        productsTable.append(`
            <tr>
                <td>${product.name}</td>
                <td>₹${product.price}</td>
                <td>
                    <span class="badge bg-${freshnessClass} freshness-tag">
                        ${product.freshness}
                    </span>
                </td>
                <td>${getStarsHTML(product.hygieneRating)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-secondary me-1">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `);
    });
}

// Load pending orders
function loadPendingOrders() {
    const ordersTable = $("#pending-orders-table tbody");
    ordersTable.empty();

    mockData.pendingOrders.forEach(order => {
        ordersTable.append(`
            <tr>
                <td>${order.vendor}</td>
                <td>${order.items}</td>
                <td>${order.quantity}</td>
                <td>${order.date}</td>
                <td>
                    <button class="btn btn-sm btn-outline-info me-1">
                        ${translations[currentLang].verify}
                    </button>
                    <button class="btn btn-sm btn-outline-success">
                        ${translations[currentLang].fulfill}
                    </button>
                </td>
            </tr>
        `);
    });
}

// Load fulfilled orders
function loadFulfilledOrders() {
    const ordersTable = $("#fulfilled-orders-table tbody");
    ordersTable.empty();

    mockData.fulfilledOrders.forEach(order => {
        const statusClass = order.status === "Delivered" ? "success" : "warning";

        ordersTable.append(`
            <tr>
                <td>${order.vendor}</td>
                <td>${order.items}</td>
                <td>${order.amount}</td>
                <td>${order.deliveryDate}</td>
                <td><span class="badge bg-${statusClass}">${order.status}</span></td>
            </tr>
        `);
    });
}

// Load group orders list
function loadGroupOrdersList() {
    const groupOrdersList = $("#group-orders-list");
    groupOrdersList.empty();

    mockData.groupOrders.forEach(order => {
        const itemsList = order.items.map(item => <li>${item}</li>).join("");

        groupOrdersList.append(`
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>${order.title}</strong>
                    <span class="badge bg-primary">${order.status}</span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>${translations[currentLang].items}:</strong></p>
                            <ul class="ps-3">
                                ${itemsList}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1"><strong>${translations[currentLang].vendors}:</strong> ${order.vendors.join(", ")}</p>
                            <p class="mb-1"><strong>${translations[currentLang].total_amount}:</strong> ${order.totalAmount}</p>
                            <p class="mb-3"><strong>${translations[currentLang].deadline}:</strong> ${order.deadline}</p>
                            <button class="btn btn-sm btn-success">
                                ${translations[currentLang].complete}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `);
    });
}

// Load reviews
function loadReviews() {
    const reviewsDiv = $("#recent-reviews");
    reviewsDiv.empty();

    mockData.reviews.forEach(review => {
        reviewsDiv.append(`
            <div class="review-item mb-3 pb-3 border-bottom">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <strong>${translations[currentLang].review_from} ${review.name}</strong>
                    <div class="stars">${getStarsHTML(review.rating)}</div>
                </div>
                <p class="mb-1">${review.text}</p>
                <small class="text-muted">${review.date}</small>
            </div>
        `);
    });
}

// Load supplier notifications
function loadSupplierNotifications() {
    const notificationsDiv = $("#supplier-notifications");
    notificationsDiv.empty();

    mockData.supplierNotifications.forEach(notification => {
        let icon = "fa-bell";
        if (notification.type === "new_order") icon = "fa-shopping-bag";
        if (notification.type === "group_order") icon = "fa-users";
        if (notification.type === "vendor_comment") icon = "fa-comment";

        notificationsDiv.append(`
            <div class="notification-item">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <i class="fas ${icon} fa-lg"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">${translations[currentLang][notification.type]}</h6>
                        <p class="mb-0">${notification.message}</p>
                        <small class="text-muted">${notification.time}</small>
                    </div>
                </div>
            </div>
        `);
    });
}

// Helper function to generate HTML for star ratings
function getStarsHTML(rating) {
    let starsHTML = "";
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 >= 0.5;

    // Add full stars
    for (let i = 0; i < fullStars; i++) {
        starsHTML += '<i class="fas fa-star"></i> ';
    }

    // Add half star if needed
    if (hasHalfStar) {
        starsHTML += '<i class="fas fa-star-half-alt"></i> ';
    }

    // Add empty stars
    const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
    for (let i = 0; i < emptyStars; i++) {
        starsHTML += '<i class="far fa-star"></i> ';
    }

    return starsHTML;
}

// API-based loading functions

// Load supplier products from API
async function loadSupplierProducts(supplierId) {
    try {
        const response = await fetch(`/api/inventory/supplier/${supplierId}`);
        if (response.ok) {
            const products = await response.json();
            displaySupplierProducts(products);
        } else {
            // Fallback to mock data
            updateSupplierProductsTable();
        }
    } catch (error) {
        console.error('Error loading supplier products:', error);
        updateSupplierProductsTable();
    }
}

// Display supplier products from API
function displaySupplierProducts(products) {
    const productsTable = $("#supplier-products-table tbody");
    productsTable.empty();
    
    products.forEach(product => {
        const freshness = 'Fresh'; // Default value
        const hygieneRating = Math.floor(Math.random() * 2) + 4; // 4-5 rating
        const freshnessClass = "success";
        
        productsTable.append(`
            <tr>
                <td>${product.item_name}</td>
                <td>₹${product.price}</td>
                <td>
                    <span class="badge bg-${freshnessClass} freshness-tag">
                        ${freshness}
                    </span>
                </td>
                <td>${getStarsHTML(hygieneRating)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-secondary me-1">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `);
    });
}

// Load supplier orders from API
async function loadSupplierOrders(supplierId) {
    try {
        const response = await fetch(`/api/orders/supplier/${supplierId}`);
        if (response.ok) {
            const orders = await response.json();
            displaySupplierOrders(orders);
        } else {
            // Fallback to mock data
            loadPendingOrders();
            loadFulfilledOrders();
            loadGroupOrdersList();
        }
    } catch (error) {
        console.error('Error loading supplier orders:', error);
        loadPendingOrders();
        loadFulfilledOrders();
        loadGroupOrdersList();
    }
}

// Display supplier orders from API
function displaySupplierOrders(orders) {
    // Separate orders by status
    const pendingOrders = orders.filter(order => order.status === 'pending');
    const fulfilledOrders = orders.filter(order => order.status === 'delivered');
    
    // Display pending orders
    const pendingTable = $("#pending-orders-table tbody");
    pendingTable.empty();
    
    pendingOrders.forEach(order => {
        pendingTable.append(`
            <tr>
                <td>${order.vendor_name || 'Unknown Vendor'}</td>
                <td>${order.item_name}</td>
                <td>${order.quantity}kg</td>
                <td>${order.date}</td>
                <td>
                    <button class="btn btn-sm btn-outline-info me-1">
                        ${translations[currentLang].verify}
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="fulfillOrder(${order.id})">
                        ${translations[currentLang].fulfill}
                    </button>
                </td>
            </tr>
        `);
    });
    
    // Display fulfilled orders
    const fulfilledTable = $("#fulfilled-orders-table tbody");
    fulfilledTable.empty();
    
    fulfilledOrders.forEach(order => {
        fulfilledTable.append(`
            <tr>
                <td>${order.vendor_name || 'Unknown Vendor'}</td>
                <td>${order.item_name}</td>
                <td>₹${order.total_price}</td>
                <td>${order.date}</td>
                <td><span class="badge bg-success">Delivered</span></td>
            </tr>
        `);
    });
    
    // Load group orders (using mock data for now)
    loadGroupOrdersList();
}

// Fulfill order function
async function fulfillOrder(orderId) {
    try {
        const response = await fetch(`/api/orders/${orderId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: 'delivered' })
        });
        
        if (response.ok) {
            alert('Order fulfilled successfully!');
            // Reload orders
            if (window.currentSupplierId) {
                loadSupplierOrders(window.currentSupplierId);
            }
        } else {
            alert('Error fulfilling order');
        }
    } catch (error) {
        console.error('Error fulfilling order:', error);
        alert('Error fulfilling order');
    }
}

// Load supplier reviews (using mock data for now)
function loadSupplierReviews() {
    loadReviews();
}
